import feedparser
import time
import os
from datetime import datetime, timedelta
from urllib.parse import quote
from openai import AzureOpenAI

# =============================
# 1. ì‚¬ìš©ì ì„ íƒ ë³€ìˆ˜ (UI ì—°ë™ ê°€ëŠ¥)
# =============================
user_selected_sources = ["ì¡°ì„ ì¼ë³´", "í•œê²¨ë ˆ", "ì¤‘ì•™ì¼ë³´", "ë™ì•„ì¼ë³´", "ê²½í–¥ì‹ ë¬¸"]  # ì˜ˆì‹œ 5ê°œ ì–¸ë¡ ì‚¬
user_follow_categories = ["ì •ì¹˜", "ê²½ì œ"]  # ì˜ˆì‹œ íŒ”ë¡œìš° ì¹´í…Œê³ ë¦¬

# =============================
# 2. ì „ì²´ ë‰´ìŠ¤/ì¹´í…Œê³ ë¦¬ ì„¤ì •
# =============================
all_sources = [
    'MBCë‰´ìŠ¤', 'ì—°í•©ë‰´ìŠ¤', 'ì¡°ì„ ì¼ë³´', 'ë‰´ìŠ¤1', 'JTBC ë‰´ìŠ¤',
    'ì¤‘ì•™ì¼ë³´', 'SBS ë‰´ìŠ¤', 'YTN', 'í•œê²¨ë ˆ', 'ê²½í–¥ì‹ ë¬¸',
    'ì˜¤ë§ˆì´ë‰´ìŠ¤', 'í•œêµ­ê²½ì œ'
]

categories = {
    'ì •ì¹˜': ['ëŒ€í†µë ¹ì‹¤', 'êµ­íšŒ', 'ì •ë‹¹', 'í–‰ì •', 'ì™¸êµ', 'êµ­ë°©/ë¶í•œ'],
    'ê²½ì œ': ['ê¸ˆìœµ/ì¦ê¶Œ', 'ì‚°ì—…/ì¬ê³„', 'ì¤‘ê¸°/ë²¤ì²˜', 'ë¶€ë™ì‚°', 'ê¸€ë¡œë²Œ', 'ìƒí™œ'],
    'ì‚¬íšŒ': ['ì‚¬ê±´ì‚¬ê³ ', 'êµìœ¡', 'ë…¸ë™', 'ì–¸ë¡ ', 'í™˜ê²½', 'ì¸ê¶Œ/ë³µì§€', 'ì‹í’ˆ/ì˜ë£Œ', 'ì§€ì—­', 'ì¸ë¬¼'],
    'IT_ê³¼í•™': ['ëª¨ë°”ì¼', 'ì¸í„°ë„·/SNS', 'í†µì‹ /ë‰´ë¯¸ë””ì–´', 'IT', 'ë³´ì•ˆ/í•´í‚¹', 'ì»´í“¨í„°', 'ê²Œì„/ë¦¬ë·°', 'ê³¼í•™'],
    'ìƒí™œ_ë¬¸í™”': ['ê±´ê°•', 'ìë™ì°¨', 'ì—¬í–‰/ë ˆì €', 'ìŒì‹/ë§›ì§‘', 'íŒ¨ì…˜/ë·°í‹°', 'ê³µì—°/ì „ì‹œ', 'ì±…', 'ì¢…êµ', 'ë‚ ì”¨', 'ìƒí™œ'],
    'ì„¸ê³„': ['ì•„ì‹œì•„/í˜¸ì£¼', 'ë¯¸êµ­/ì¤‘ë‚¨ë¯¸', 'ìœ ëŸ½', 'ì¤‘ë™/ì•„í”„ë¦¬ì¹´', 'ì„¸ê³„']
}

MAX_ARTICLES_PER_CATEGORY = 100
save_path = 'D:/í•œêµ­ê¸°ìˆ êµìœ¡ëŒ€í•™êµ/2025ë…„ 2í•™ë…„ ì—¬ë¦„ ê³„ì ˆ/ë§ˆì´í¬ë¡œì†Œí”„íŠ¸ AI/í…€í”„/output'
one_month_ago = datetime.now() - timedelta(days=30)
os.makedirs(save_path, exist_ok=True)

# =============================
# 3. Azure OpenAI ì´ˆê¸°í™”
# =============================
endpoint = "https://newscheck2.openai.azure.com/"
deployment = "gpt-5-nano"
subscription_key = "Dsf5DmuTn1cS7lXaSxSTnO30kTZCqr2xKqIjLwvdovEGnQsz3NjlJQQJ99BHACHYHv6XJ3w3AAABACOGJk53"

client = AzureOpenAI(
    azure_endpoint=endpoint,
    api_key=subscription_key,
    api_version="2025-01-01-preview",
)

# =============================
# 4. ë‰´ìŠ¤ ìˆ˜ì§‘ í•¨ìˆ˜
# =============================
def fetch_news(sub_category, main_category):
    encoded_keyword = quote(sub_category)
    news_url = f"https://news.google.com/rss/search?q={encoded_keyword}&hl=ko&gl=KR"
    feed = feedparser.parse(news_url)

    articles = []
    saved_count = 0

    for entry in feed.entries:
        if saved_count >= MAX_ARTICLES_PER_CATEGORY:
            break

        # ì–¸ë¡ ì‚¬ í•„í„°ë§
        if hasattr(entry, 'source') and entry.source.title in all_sources:
            published_time = entry.get('published_parsed')
            if not published_time:
                continue
            article_date = datetime.fromtimestamp(time.mktime(published_time))
            if article_date < one_month_ago:
                continue

            articles.append({
                'title': entry.title,
                'link': entry.link,
                'source': entry.source.title,
                'date': article_date.strftime('%Y-%m-%d %H:%M:%S'),
                'content': entry.title  # í˜„ì¬ RSSì—ëŠ” ë³¸ë¬¸ì´ ì—†ìœ¼ë¯€ë¡œ ì œëª©ìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥
            })
            saved_count += 1

    return articles

# =============================
# 5. GPT í‰ê°€ í•¨ìˆ˜
# =============================
def gpt_evaluate(article_text, selected_sources):
    prompt_text = f"""
ì‚¬ìš©ìê°€ ì„ íƒí•œ 5ê°œ ì–¸ë¡ ì‚¬: {', '.join(selected_sources)}
ë‹¤ìŒ ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ 3ì¤„ë¡œ ìš”ì•½í•˜ê³ , ì„ íƒí•œ 5ê°œ ì–¸ë¡ ì‚¬ ê¸°ì¤€ìœ¼ë¡œ ë¹„êµí•´ì£¼ì„¸ìš”.
- ë¹„êµ ë°©ë²•: ë™ì¼ ì´ìŠˆë¥¼ ë‹¤ë£¬ ë‹¤ë¥¸ í•µì‹¬ ì–¸ë¡ ì‚¬ ê¸°ì‚¬ì™€ í•µì‹¬ ì£¼ì¥ ì¼ì¹˜ë„ í™•ì¸
- ì‹ ë¢°ë„ ì ìˆ˜ ê³„ì‚°: 100 - ((ì •ì • ë³´ë„ ê±´ìˆ˜ + ê°€ì§œë‰´ìŠ¤ ê±´ìˆ˜) * 1.25)
- ì ìˆ˜ ë“±ê¸‰:
    - ë†’ìŒ: >= 70
    - ë³´í†µ: >= 40
    - ë‚®ìŒ: < 40
ì¶œë ¥ í˜•ì‹:
1) 3ì¤„ ìš”ì•½
2) ë‹¤ë¥¸ ì–¸ë¡ ì‚¬ì™€ ë¹„êµ ê²°ê³¼
3) ì ìˆ˜
4) ì‹ ë¢°ë„ ë“±ê¸‰
"""

    messages = [
        {"role": "user", "content": article_text},
        {"role": "assistant", "content": prompt_text}
    ]

    try:
        completion = client.chat.completions.create(
            model=deployment,
            messages=messages,
            max_completion_tokens=2048,
            stop=None
        )
        result_text = completion.choices[0].message.content
        return result_text
    except Exception as e:
        return f"GPT í‰ê°€ ì˜¤ë¥˜: {e}"

# =============================
# 6. íŒŒì¼ ì €ì¥ í•¨ìˆ˜
# =============================
def save_news(main_category, sub_category, articles):
    main_path = os.path.join(save_path, main_category)
    os.makedirs(main_path, exist_ok=True)
    file_name = f"{sub_category.replace('/', '_')}_news.txt"
    full_path = os.path.join(main_path, file_name)

    with open(full_path, 'w', encoding='utf-8') as f:
        for article in articles:
            f.write(f"ì œëª©: {article['title']}\n")
            f.write(f"ì–¸ë¡ ì‚¬: {article['source']}\n")
            f.write(f"ë§í¬: {article['link']}\n")
            f.write(f"ë°œí–‰ ì‹œê°„: {article['date']}\n")
            f.write("GPT í‰ê°€ ê²°ê³¼:\n")
            f.write(article.get('evaluation', '') + "\n")
            f.write("-" * 50 + "\n\n")

# =============================
# 7. ë©”ì¸ ì‹¤í–‰ ë£¨í”„
# =============================
for main_category, sub_categories in categories.items():
    if main_category not in user_follow_categories:
        continue  # íŒ”ë¡œìš° ì•ˆ í•œ ì¹´í…Œê³ ë¦¬ ê±´ë„ˆëœ€

    for sub_category in sub_categories:
        print(f"[{main_category}] {sub_category} ë‰´ìŠ¤ ìˆ˜ì§‘ ì¤‘...")
        articles = fetch_news(sub_category, main_category)

        for article in articles:
            article['evaluation'] = gpt_evaluate(article['content'], user_selected_sources)
            time.sleep(1)  # ì„œë²„ ë¶€ë‹´ ë°©ì§€

        save_news(main_category, sub_category, articles)
        print(f"  -> {len(articles)}ê°œ ë‰´ìŠ¤ ì €ì¥ ì™„ë£Œ")

print("\nğŸ‰ ëª¨ë“  ë‰´ìŠ¤ ìˆ˜ì§‘ ë° GPT í‰ê°€ ì™„ë£Œ!")
